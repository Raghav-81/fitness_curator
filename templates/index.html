<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workout Video Search</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }
        
        .header h1 {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .search-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            margin-bottom: 30px;
        }
        
        .search-box {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .search-input {
            flex: 1;
            padding: 15px 20px;
            font-size: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            transition: border-color 0.3s;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .search-btn {
            padding: 15px 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .search-btn:hover {
            transform: translateY(-2px);
        }
        
        .filters {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        
        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }
        
        .filter-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .stats {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        .results-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .results-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .results-header h2 {
            color: #333;
            font-size: 1.5rem;
        }
        
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .video-card {
            border: 2px solid #f0f0f0;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .video-card:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2);
        }
        
        .video-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }
        
        .video-meta {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }
        
        .video-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .badge-category {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .badge-difficulty {
            background: #fff3e0;
            color: #f57c00;
        }
        
        .badge-duration {
            background: #f3e5f5;
            color: #7b1fa2;
        }
        
        .video-description {
            color: #666;
            font-size: 0.9rem;
            line-height: 1.5;
            margin-top: 10px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .loading i {
            font-size: 3rem;
            color: #667eea;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            100% { transform: rotate(360deg); }
        }
        
        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .no-results i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        .video-score {
            display: inline-block;
            padding: 4px 10px;
            background: #4caf50;
            color: white;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        /* Video Modal */
        .video-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .video-modal.active {
            display: flex;
        }
        
        .video-modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        
        .video-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #f44336;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .video-modal-close:hover {
            background: #d32f2f;
        }
        
        .video-player {
            width: 100%;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: 10px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-dumbbell"></i> Workout Video Search</h1>
            <p>Find the perfect workout videos with advanced search</p>
        </div>
        
        <div class="search-container">
            <div class="search-box">
                <input 
                    type="text" 
                    id="search-input" 
                    class="search-input" 
                    placeholder="Search for workouts... (e.g., yoga, HIIT, strength training)"
                    autocomplete="off"
                >
                <button id="search-btn" class="search-btn">
                    <i class="fas fa-search"></i> Search
                </button>
            </div>
            
            <div class="filters">
                <div class="filter-group">
                    <label for="category-filter">Category</label>
                    <select id="category-filter">
                        <option value="">All Categories</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="results-limit">Results</label>
                    <select id="results-limit">
                        <option value="10">10 results</option>
                        <option value="20">20 results</option>
                        <option value="50">50 results</option>
                        <option value="100">100 results</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="stats" id="stats-container">
            <div class="stat-item">
                <div class="stat-value" id="total-videos">-</div>
                <div class="stat-label">Total Videos</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="total-categories">-</div>
                <div class="stat-label">Categories</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="search-results">0</div>
                <div class="stat-label">Search Results</div>
            </div>
        </div>
        
        <div class="results-container">
            <div class="error-message" id="error-message"></div>
            
            <div class="results-header">
                <h2 id="results-title">All Videos</h2>
            </div>
            
            <div id="results" class="video-grid">
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <p>Loading videos...</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Video Modal -->
    <div id="video-modal" class="video-modal" onclick="if(event.target === this) closeVideoModal()">
        <div class="video-modal-content">
            <button class="video-modal-close" onclick="closeVideoModal()">
                <i class="fas fa-times"></i>
            </button>
            <h2 id="modal-video-title" style="margin-bottom: 20px;"></h2>
            <div id="modal-video-player"></div>
            <div id="modal-video-meta" class="video-meta" style="margin-bottom: 15px;"></div>
            <div id="modal-video-description" style="color: #666; line-height: 1.6;"></div>
        </div>
    </div>
    
    <script>
        // State
        let allVideos = [];
        let categories = [];
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadInitialData();
            setupEventListeners();
        });
        
        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('search-btn').addEventListener('click', performSearch);
            document.getElementById('search-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') performSearch();
            });
            document.getElementById('category-filter').addEventListener('change', performSearch);
        }
        
        // Load initial data
        async function loadInitialData() {
            try {
                // Load all videos
                const videosResponse = await fetch('/api/videos');
                allVideos = await videosResponse.json();
                
                // Load categories
                const categoriesResponse = await fetch('/api/categories');
                const categoriesData = await categoriesResponse.json();
                categories = categoriesData.categories || [];
                
                // Populate category filter
                const categoryFilter = document.getElementById('category-filter');
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    categoryFilter.appendChild(option);
                });
                
                // Update stats
                document.getElementById('total-videos').textContent = allVideos.length;
                document.getElementById('total-categories').textContent = categories.length;
                
                // Display all videos initially
                displayVideos(allVideos);
                
            } catch (error) {
                showError('Failed to load data: ' + error.message);
            }
        }
        
        // Perform search
        async function performSearch() {
            const query = document.getElementById('search-input').value.trim();
            const category = document.getElementById('category-filter').value;
            const limit = parseInt(document.getElementById('results-limit').value);
            
            // If no query, show all videos (filtered by category if selected)
            if (!query) {
                let filtered = allVideos;
                if (category) {
                    filtered = allVideos.filter(v => v.category === category);
                }
                displayVideos(filtered.slice(0, limit));
                document.getElementById('results-title').textContent = 
                    category ? `${category} Videos` : 'All Videos';
                return;
            }
            
            // Perform search
            try {
                showLoading();
                
                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        query: query,
                        category: category || null,
                        top_k: limit,
                        min_score: 0.0
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Search failed');
                }
                
                const data = await response.json();
                const videos = data.results.map(r => ({
                    ...r.video,
                    score: r.score,
                    method: r.method
                }));
                
                displayVideos(videos);
                document.getElementById('results-title').textContent = 
                    `Search Results for "${query}"`;
                document.getElementById('search-results').textContent = videos.length;
                
            } catch (error) {
                showError('Search failed: ' + error.message);
            }
        }
        
        // Display videos
        function displayVideos(videos) {
            const resultsContainer = document.getElementById('results');
            
            if (videos.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="no-results">
                        <i class="fas fa-search"></i>
                        <h3>No videos found</h3>
                        <p>Try a different search term or category</p>
                    </div>
                `;
                return;
            }
            
            resultsContainer.innerHTML = videos.map((video, index) => `
                <div class="video-card" onclick="openVideoModal(${index})" data-video-index="${index}">
                    <div class="video-title">${video.title}</div>
                    <div class="video-meta">
                        ${video.category ? `<span class="video-badge badge-category">${video.category}</span>` : ''}
                        ${video.difficulty_level ? `<span class="video-badge badge-difficulty">${video.difficulty_level}</span>` : ''}
                        ${video.duration ? `<span class="video-badge badge-duration">${formatDuration(video.duration)}</span>` : ''}
                        ${video.score ? `<span class="video-score">${normalizeScore(video.score)}% match</span>` : ''}
                    </div>
                    ${video.description ? `<div class="video-description">${video.description}</div>` : ''}
                    ${video.equipment_needed && video.equipment_needed.length > 0 ? 
                        `<div class="video-meta" style="margin-top: 10px;">
                            <small><i class="fas fa-tools"></i> ${video.equipment_needed.join(', ')}</small>
                        </div>` : ''}
                </div>
            `).join('');
            
            // Store videos for modal access
            window.currentVideos = videos;
        }
        
        // Format duration
        function formatDuration(seconds) {
            if (!seconds) return '--:--';
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        
        // Normalize score to 0-100 range
        function normalizeScore(score) {
            // Scores from search can be > 1.0, so we normalize them
            // If score is already between 0-1, multiply by 100
            // If score is > 1, cap it at 100
            if (score <= 1.0) {
                return Math.round(score * 100);
            } else {
                // For scores > 1, normalize to 0-100 scale
                // Assuming max reasonable score is around 3-4
                return Math.min(100, Math.round((score / 4) * 100));
            }
        }
        
        // Open video modal
        function openVideoModal(index) {
            const video = window.currentVideos[index];
            if (!video) return;
            
            const modal = document.getElementById('video-modal');
            const modalTitle = document.getElementById('modal-video-title');
            const modalPlayer = document.getElementById('modal-video-player');
            const modalDescription = document.getElementById('modal-video-description');
            const modalMeta = document.getElementById('modal-video-meta');
            
            // Set title
            modalTitle.textContent = video.title;
            
            // Set video player
            const videoSource = video.video_url || video.file_path;
            
            if (videoSource) {
                // Check if it's a Google Drive link
                if (videoSource.includes('drive.google.com')) {
                    // Extract file ID from Google Drive URL
                    const fileIdMatch = videoSource.match(/id=([^&]+)/);
                    if (fileIdMatch) {
                        const fileId = fileIdMatch[1];
                        // Use Google Drive embed URL
                        modalPlayer.innerHTML = `
                            <iframe 
                                src="https://drive.google.com/file/d/${fileId}/preview" 
                                class="video-player" 
                                allow="autoplay"
                                style="border: none;">
                            </iframe>
                        `;
                    } else {
                        // Fallback: Open in new tab button
                        modalPlayer.innerHTML = `
                            <div class="video-player" style="display: flex; align-items: center; justify-content: center; flex-direction: column; color: white;">
                                <i class="fas fa-video" style="font-size: 3rem; margin-bottom: 20px;"></i>
                                <p style="margin-bottom: 15px;">Video hosted on Google Drive</p>
                                <a href="${videoSource}" target="_blank" style="padding: 10px 20px; background: #667eea; color: white; text-decoration: none; border-radius: 8px;">
                                    <i class="fas fa-external-link-alt"></i> Open in Google Drive
                                </a>
                            </div>
                        `;
                    }
                } else {
                    // Regular video file
                    modalPlayer.innerHTML = `
                        <video controls class="video-player">
                            <source src="${videoSource}" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                    `;
                }
            } else {
                modalPlayer.innerHTML = `
                    <div class="video-player" style="display: flex; align-items: center; justify-content: center; color: white;">
                        <div style="text-align: center;">
                            <i class="fas fa-video" style="font-size: 3rem; margin-bottom: 10px;"></i>
                            <p>Video file not available</p>
                        </div>
                    </div>
                `;
            }
            
            // Set description
            if (video.description && video.description.trim()) {
                modalDescription.innerHTML = `<p style="margin-bottom: 15px;">${video.description}</p>`;
            } else {
                modalDescription.innerHTML = `<p style="color: #999; font-style: italic;">No description available for this video.</p>`;
            }
            
            // Set metadata - show all available info
            let metaHTML = '<div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">';
            
            // Always show category
            if (video.category) {
                metaHTML += `<span class="video-badge badge-category"><i class="fas fa-tag"></i> ${video.category}</span>`;
            }
            
            // Show difficulty if available
            if (video.difficulty_level) {
                metaHTML += `<span class="video-badge badge-difficulty"><i class="fas fa-signal"></i> ${video.difficulty_level}</span>`;
            }
            
            // Show duration if available
            if (video.duration) {
                metaHTML += `<span class="video-badge badge-duration"><i class="fas fa-clock"></i> ${formatDuration(video.duration)}</span>`;
            }
            
            metaHTML += '</div>';
            
            // Show equipment if available
            if (video.equipment_needed && video.equipment_needed.length > 0) {
                metaHTML += `
                    <div style="margin-bottom: 15px; padding: 10px; background: #f5f5f5; border-radius: 8px;">
                        <strong><i class="fas fa-tools"></i> Equipment Needed:</strong>
                        <div style="margin-top: 5px;">${video.equipment_needed.join(', ')}</div>
                    </div>
                `;
            }
            
            // Show keywords if available
            if (video.keywords && video.keywords.length > 0) {
                metaHTML += `
                    <div style="margin-bottom: 15px;">
                        <strong><i class="fas fa-key"></i> Keywords:</strong>
                        <div style="margin-top: 5px; display: flex; flex-wrap: wrap; gap: 5px;">
                            ${video.keywords.map(kw => `<span style="background: #e3f2fd; padding: 3px 8px; border-radius: 12px; font-size: 0.85rem;">${kw}</span>`).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Show video ID for reference
            metaHTML += `<div style="margin-top: 10px; font-size: 0.85rem; color: #999;">Video ID: ${video.id}</div>`;
            
            modalMeta.innerHTML = metaHTML;
            
            // Show modal
            modal.classList.add('active');
        }
        
        // Close video modal
        function closeVideoModal() {
            const modal = document.getElementById('video-modal');
            const modalPlayer = document.getElementById('modal-video-player');
            
            // Stop video playback
            modalPlayer.innerHTML = '';
            
            // Hide modal
            modal.classList.remove('active');
        }
        
        // Show loading
        function showLoading() {
            document.getElementById('results').innerHTML = `
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <p>Searching...</p>
                </div>
            `;
        }
        
        // Show error
        function showError(message) {
            const errorEl = document.getElementById('error-message');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            setTimeout(() => {
                errorEl.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>
